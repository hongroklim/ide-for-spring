# maven build
FROM maven:3.6.3-openjdk-8-slim

ARG APP_NAME=bean-cafe

# copy repository
RUN mkdir -p /root/.m2/repository

COPY $APP_NAME/pom.xml /tmp/$APP_NAME/pom.xml
COPY $APP_NAME/src /tmp/$APP_NAME/src

RUN mvn clean package -f "/tmp/$APP_NAME/pom.xml"

# wildfly
FROM jboss/wildfly:20.0.1.Final

ARG APP_NAME=bean-cafe

COPY --from=0 /root/wildfly/standalone/deployments/$APP_NAME.war /tmp/$APP_NAME.war

USER root
RUN mv /tmp/$APP_NAME.war $JBOSS_HOME/standalone/deployments/ \
    && mkdir -p $JBOSS_HOME/standalone/log/ \
    && touch server.log audit.log \
    && chown -R jboss:0 $JBOSS_HOME/standalone/log/
USER jboss
#RUN chown -R jboss:0 $JBOSS_HOME/standalone/deployments/$APP_NAME.war \
#USER root
#RUN chmod 646 -R $JBOSS_HOME/standalone/deployments/$APP_NAME.war
#USER jboss

# TODO standalone.xml

# deployments volume
